<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Dashboard IA Agent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    body { background: #f8f9fa; }
    .dashboard-container { max-width: 900px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px #0001; padding: 32px; }
    .section-title { margin-top: 32px; margin-bottom: 16px; }
    .response-box { background: #f1f3f4; border-radius: 8px; padding: 16px; min-height: 80px; }
    .doc-list { max-height: 200px; overflow-y: auto; }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <h1 class="mb-4">Tableau de bord - Agent IA</h1>

    <h4 class="section-title">Utilisateur</h4>
    <form id="user-form" class="mb-3">
      <div class="row g-2 align-items-end">
        <div class="col-md-5">
          <input type="email" class="form-control" id="user-email" placeholder="Votre email" required>
        </div>
        <div class="col-md-4">
          <input type="text" class="form-control" id="user-name" placeholder="Votre nom (optionnel)">
        </div>
        <div class="col-md-3">
          <input type="password" class="form-control" id="user-password" placeholder="Mot de passe" required>
        </div>
        <div class="col-md-12 mt-2">
          <button class="btn btn-secondary me-2" id="signup-btn" type="button">Créer un compte</button>
          <button class="btn btn-primary" id="login-btn" type="button">Connexion</button>
        </div>
      </div>
      <div id="user-auth-result" class="mt-2"></div>
    </form>

    <h4 class="section-title">1. Discuter avec l'agent</h4>
    <form id="ask-form" class="mb-3">
      <div class="input-group">
        <input type="text" class="form-control" id="question" placeholder="Posez une question à l'agent..." required>
        <button class="btn btn-primary" type="submit">Envoyer</button>
      </div>
    </form>
    <div id="response" class="response-box mb-4"></div>

    <h4 class="section-title">2. Uploader un document texte</h4>
    <form id="upload-doc-form" class="mb-3">
      <div class="mb-2">
        <input type="text" class="form-control" id="doc-title" placeholder="Titre du document" required>
      </div>
      <div class="mb-2">
        <textarea class="form-control" id="doc-content" rows="3" placeholder="Contenu du document" required></textarea>
      </div>
      <button class="btn btn-success" type="submit">Uploader</button>
    </form>
    <div id="upload-doc-result" class="mb-4"></div>

    <h4 class="section-title">3. Uploader un fichier (.docx, .txt)</h4>
    <form id="upload-file-form" enctype="multipart/form-data" class="mb-3">
      <div class="mb-2">
        <input type="text" class="form-control" id="file-title" name="title" placeholder="Titre du fichier (optionnel)">
      </div>
      <div class="mb-2">
        <input type="file" class="form-control" id="file-input" name="file" accept=".docx,.txt" required>
      </div>
      <button class="btn btn-info" type="submit">Uploader le fichier</button>
    </form>
    <div id="upload-file-result" class="mb-4"></div>

    <h4 class="section-title">Historique de chat</h4>
    <div id="history-list" class="doc-list mb-4"></div>
  </div>

  <script>
    let userEmail = localStorage.getItem('userEmail') || '';
    let userName = localStorage.getItem('userName') || '';
    let userPassword = '';
    document.getElementById('user-email').value = userEmail;
    document.getElementById('user-name').value = userName;

    document.getElementById('signup-btn').onclick = async function() {
      userEmail = document.getElementById('user-email').value.trim();
      userName = document.getElementById('user-name').value.trim();
      userPassword = document.getElementById('user-password').value;
      if (!userEmail || !userPassword) return alert('Email et mot de passe requis.');
      const res = await fetch('/api/signup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: userEmail, name: userName, password: userPassword })
      });
      const data = await res.json();
      document.getElementById('user-auth-result').textContent = data.success ? 'Compte créé !' : (data.error || 'Erreur.');
      if (data.success) {
        localStorage.setItem('userEmail', userEmail);
        localStorage.setItem('userName', userName);
        loadUserHistory();
      }
    };
    document.getElementById('login-btn').onclick = async function() {
      userEmail = document.getElementById('user-email').value.trim();
      userName = document.getElementById('user-name').value.trim();
      userPassword = document.getElementById('user-password').value;
      if (!userEmail || !userPassword) return alert('Email et mot de passe requis.');
      const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: userEmail, password: userPassword })
      });
      const data = await res.json();
      document.getElementById('user-auth-result').textContent = data.success ? 'Connecté !' : (data.error || 'Erreur.');
      if (data.success) {
        localStorage.setItem('userEmail', userEmail);
        localStorage.setItem('userName', userName);
        loadUserHistory();
      }
    };

    // Affichage de l'historique utilisateur
    async function loadUserHistory() {
      if (!userEmail) return;
      const res = await fetch(`/api/user-history?email=${encodeURIComponent(userEmail)}`);
      const data = await res.json();
      const historyDiv = document.getElementById('history-list');
      if (!data.history || data.history.length === 0) {
        historyDiv.innerHTML = '<em>Aucun historique pour cet utilisateur.</em>';
        return;
      }
      let html = '<ul class="list-group">';
      for (let i = 0; i < data.history.length; i += 2) {
        const userMsg = data.history[i];
        const agentMsg = data.history[i + 1];
        if (userMsg && userMsg.role === 'user') {
          html += `<li class="list-group-item"><b>Vous :</b> ${userMsg.content}<br>`;
          if (agentMsg && agentMsg.role === 'agent') {
            html += `<b>Agent :</b> ${agentMsg.content}`;
          }
          html += '</li>';
        }
      }
      html += '</ul>';
      historyDiv.innerHTML = html;
    }
    // Charger l'historique au chargement et à la validation utilisateur
    window.addEventListener('DOMContentLoaded', loadUserHistory);
    document.getElementById('user-form').addEventListener('submit', loadUserHistory);

    // Gestion question à l'agent
    document.getElementById('ask-form').onsubmit = async function(e) {
      e.preventDefault();
      const question = document.getElementById('question').value;
      document.getElementById('response').textContent = 'Réponse en cours...';
      const res = await fetch('/api/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question, userEmail, userName })
      });
      const data = await res.json();
      document.getElementById('response').textContent = data.response || (data.error ? 'Erreur : ' + data.error : 'Aucune réponse.');
      loadUserHistory(); // Rafraîchir l'historique après chaque question
    };

    // Gestion upload document texte
    document.getElementById('upload-doc-form').onsubmit = async function(e) {
      e.preventDefault();
      const title = document.getElementById('doc-title').value;
      const content = document.getElementById('doc-content').value;
      document.getElementById('upload-doc-result').textContent = 'Envoi en cours...';
      const res = await fetch('/api/upload-doc', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, content })
      });
      const data = await res.json();
      document.getElementById('upload-doc-result').textContent = data.success ? 'Document enregistré !' : 'Erreur : ' + (data.error || '');
    };

    // Gestion upload fichier
    document.getElementById('upload-file-form').onsubmit = async function(e) {
      e.preventDefault();
      const formData = new FormData();
      const fileInput = document.getElementById('file-input');
      const title = document.getElementById('file-title').value;
      if (title) formData.append('title', title);
      formData.append('file', fileInput.files[0]);
      document.getElementById('upload-file-result').textContent = 'Envoi en cours...';
      const res = await fetch('/api/upload-file', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      document.getElementById('upload-file-result').textContent = data.success ? 'Fichier enregistré !' : 'Erreur : ' + (data.error || '');
    };
  </script>
</body>
</html>
